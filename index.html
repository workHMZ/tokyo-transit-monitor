<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êù±‰∫¨‰∫§ÈÄöÊÉÖÂ†± - Glance</title>
    <style>
        :root {
            --color-background: hsl(240, 8%, 9%);
            --color-widget-background: hsl(240, 8%, 10%);
            --color-widget-background-highlight: hsl(240, 8%, 14%);
            --color-separator: hsl(240, 8%, 13%);
            --color-widget-content-border: hsl(240, 8%, 13%);
            --color-primary: hsl(43, 50%, 70%);
            --color-text-highlight: hsl(240, 8%, 85%);
            --color-text-base: hsl(240, 8%, 58%);
            --color-text-subdue: hsl(240, 8%, 35%);
            --color-success: hsl(142, 50%, 45%);
            --color-warning: hsl(38, 90%, 55%);
            --color-error: hsl(0, 70%, 55%);
            --border-radius: 5px;
            --font-family: 'JetBrains Mono', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --color-background: hsl(0, 0%, 98%);
                --color-widget-background: hsl(0, 0%, 100%);
                --color-widget-background-highlight: hsl(0, 0%, 96%);
                --color-separator: hsl(0, 0%, 90%);
                --color-widget-content-border: hsl(0, 0%, 85%);
                --color-primary: hsl(43, 70%, 55%);
                --color-text-highlight: hsl(0, 0%, 10%);
                --color-text-base: hsl(0, 0%, 40%);
                --color-text-subdue: hsl(0, 0%, 65%);
                --color-success: hsl(142, 60%, 35%);
                --color-warning: hsl(38, 80%, 45%);
                --color-error: hsl(0, 65%, 50%);
            }
        }

        body.light-theme {
            --color-background: hsl(0, 0%, 98%);
            --color-widget-background: hsl(0, 0%, 100%);
            --color-widget-background-highlight: hsl(0, 0%, 96%);
            --color-separator: hsl(0, 0%, 90%);
            --color-widget-content-border: hsl(0, 0%, 85%);
            --color-primary: hsl(43, 70%, 55%);
            --color-text-highlight: hsl(0, 0%, 10%);
            --color-text-base: hsl(0, 0%, 40%);
            --color-text-subdue: hsl(0, 0%, 65%);
            --color-success: hsl(142, 60%, 35%);
            --color-warning: hsl(38, 80%, 45%);
            --color-error: hsl(0, 65%, 50%);
        }

        body.dark-theme {
            --color-background: hsl(240, 8%, 9%);
            --color-widget-background: hsl(240, 8%, 10%);
            --color-widget-background-highlight: hsl(240, 8%, 14%);
            --color-separator: hsl(240, 8%, 13%);
            --color-widget-content-border: hsl(240, 8%, 13%);
            --color-primary: hsl(43, 50%, 70%);
            --color-text-highlight: hsl(240, 8%, 85%);
            --color-text-base: hsl(240, 8%, 58%);
            --color-text-subdue: hsl(240, 8%, 35%);
            --color-success: hsl(142, 50%, 45%);
            --color-warning: hsl(38, 90%, 55%);
            --color-error: hsl(0, 70%, 55%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-base);
            font-size: 13px;
            line-height: 1.5;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100%;
            background-color: var(--color-widget-background);
        }

        .header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--color-widget-content-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-widget-background);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-text-highlight);
            font-weight: 600;
            font-size: 14px;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 11px;
            color: var(--color-text-subdue);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--color-success);
        }

        .status-dot.has-issues {
            background-color: var(--color-warning);
        }

        .data-info {
            padding: 0.4rem 1rem;
            background-color: var(--color-widget-background-highlight);
            border-bottom: 1px solid var(--color-separator);
            font-size: 11px;
            color: var(--color-text-subdue);
        }

        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .status-summary {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: var(--color-widget-background-highlight);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--color-success);
        }

        .status-summary.has-issues {
            border-left-color: var(--color-warning);
        }

        .summary-text {
            color: var(--color-text-highlight);
            font-weight: 500;
        }

        .line-list {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .line-item {
            padding: 0.6rem 0.75rem;
            background-color: var(--color-widget-background-highlight);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-separator);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .line-item:hover {
            border-color: var(--color-primary);
            background-color: var(--color-widget-background);
        }

        .line-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .line-icon {
            font-size: 12px;
        }

        .line-name {
            color: var(--color-text-highlight);
            font-weight: 500;
            font-size: 12px;
            flex-grow: 1;
        }

        .line-status {
            font-size: 10px;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            background-color: var(--color-warning);
            color: #000;
            font-weight: 500;
        }

        .line-detail {
            color: var(--color-text-base);
            font-size: 11px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-item.expanded .line-detail {
            -webkit-line-clamp: unset;
            overflow: visible;
        }

        .all-clear {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            color: var(--color-text-subdue);
        }

        .all-clear-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .all-clear-text {
            color: var(--color-success);
            font-weight: 500;
            font-size: 14px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--color-text-subdue);
        }

        .error-message {
            padding: 1rem;
            margin: 0.5rem;
            background-color: var(--color-widget-background-highlight);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--color-error);
            color: var(--color-text-base);
            font-size: 12px;
        }

        .footer {
            padding: 0.5rem 1rem;
            border-top: 1px solid var(--color-widget-content-border);
            font-size: 10px;
            color: var(--color-text-subdue);
            text-align: center;
            background-color: var(--color-widget-background);
        }

        .footer a {
            color: var(--color-primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                üöÉ Êù±‰∫¨‰∫§ÈÄöÊÉÖÂ†±
            </div>
            <div class="header-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="updateTime">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
            </div>
        </div>
        <div class="data-info" id="dataInfo">
            üìÖ „Éá„Éº„ÇøÂèñÂæó: <span id="fetchTime">--</span>
        </div>

        <div class="content" id="content">
            <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>

        <div class="footer">
            „Éá„Éº„Çø: <a href="https://transit.yahoo.co.jp/diainfo/area/4" target="_blank">Yahoo!Ë∑ØÁ∑öÊÉÖÂ†±</a>
        </div>
    </div>

    <script>
        // Theme detection (same as before)
        function detectAndApplyTheme() {
            let isLightTheme = false;
            try {
                if (window.parent && window.parent !== window) {
                    const parentBody = window.parent.document.body;
                    const parentBg = window.getComputedStyle(parentBody).backgroundColor;
                    const rgb = parentBg.match(/\d+/g);
                    if (rgb) {
                        const brightness = (parseInt(rgb[0]) * 299 + parseInt(rgb[1]) * 587 + parseInt(rgb[2]) * 114) / 1000;
                        isLightTheme = brightness > 127;
                    }
                }
            } catch (e) {
                isLightTheme = window.matchMedia('(prefers-color-scheme: light)').matches;
            }
            document.body.className = isLightTheme ? 'light-theme' : 'dark-theme';
        }

        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', detectAndApplyTheme);
        }
        detectAndApplyTheme();

        // Data loading
        const DATA_URL = 'transit_data.json';

        async function loadTransitData() {
            const content = document.getElementById('content');
            const statusDot = document.getElementById('statusDot');
            const updateTime = document.getElementById('updateTime');

            try {
                const response = await fetch(DATA_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error('„Éá„Éº„Çø„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');

                const data = await response.json();

                // Update header and data info
                const fetchTime = document.getElementById('fetchTime');
                updateTime.textContent = data.issue_count > 0 ? `${data.issue_count}‰ª∂„ÅÆÈÅÖÂª∂` : 'Ê≠£Â∏∏';
                fetchTime.textContent = data.update_time || '‰∏çÊòé';

                if (data.status === 'all_clear' || data.issue_count === 0) {
                    statusDot.classList.remove('has-issues');
                    content.innerHTML = `
                        <div class="all-clear">
                            <div class="all-clear-icon">‚úÖ</div>
                            <div class="all-clear-text">ÂÖ®Á∑öÊ≠£Â∏∏ÈÅãËª¢‰∏≠</div>
                            <div style="margin-top: 0.5rem; font-size: 11px;">Áõ£Ë¶ñ‰∏≠: ${data.monitored_lines_count || 0}Ë∑ØÁ∑ö</div>
                        </div>
                    `;
                } else {
                    statusDot.classList.add('has-issues');

                    let html = `
                        <div class="status-summary has-issues">
                            <div class="summary-text">‚ö†Ô∏è ${data.issue_count}‰ª∂„ÅÆÈÅãË°åÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åô</div>
                        </div>
                        <div class="line-list">
                    `;

                    data.issues.forEach((issue, index) => {
                        html += `
                            <div class="line-item" onclick="this.classList.toggle('expanded')">
                                <div class="line-header">
                                    <span class="line-icon">üöÉ</span>
                                    <span class="line-name">${escapeHtml(issue.line)}</span>
                                    <span class="line-status">${escapeHtml(issue.status)}</span>
                                </div>
                                <div class="line-detail">${escapeHtml(issue.detail)}</div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    content.innerHTML = html;
                }

            } catch (error) {
                content.innerHTML = `
                    <div class="error-message">
                        ‚ö†Ô∏è ${error.message}<br>
                        <small>„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ</small>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initial load
        loadTransitData();

        // Theme check interval
        setInterval(detectAndApplyTheme, 1000);

        // Auto refresh every 5 minutes
        setInterval(loadTransitData, 5 * 60 * 1000);
    </script>
</body>

</html>