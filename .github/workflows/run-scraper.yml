# =============================================================================
# å®šæ—¶è¿è¡Œçˆ¬è™« + å‘é€é€šçŸ¥åˆ° Synology Chat + æ›´æ–° GitHub Pages
# =============================================================================
# è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š 8:00 å’Œä¸‹åˆ 5:30 (JST) è‡ªåŠ¨è¿è¡Œ æˆ– æ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½ï¼šè¿è¡Œäº¤é€šçˆ¬è™«ï¼Œå°†ç»“æœå‘é€åˆ° Synology Chat å¹¶æ›´æ–° GitHub Pages
# =============================================================================

name: ğŸšƒ Run Scraper (8AM & 5:30PM JST)

on:
  # å®šæ—¶è§¦å‘ï¼š
  # - æ¯å¤©æ—©ä¸Š 8:00 JST (= å‰ä¸€å¤© 23:00 UTC)
  # - æ¯å¤©ä¸‹åˆ 5:30 JST (= å½“å¤© 8:30 UTC)
  schedule:
    - cron: '0 23 * * *'   # 8:00 JST
    - cron: '30 8 * * *'   # 17:30 JST
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      send_notification:
        description: 'æ˜¯å¦å‘é€é€šçŸ¥åˆ° Synology Chatï¼Ÿ'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  run-scraper:
    name: ğŸš€ Run Scraper & Update
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æ›´æ–° GitHub Pages

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: ğŸš€ Run Scraper
        id: scraper
        run: |
          echo "=========================================="
          echo " è¿è¡Œçˆ¬è™«..."
          echo "=========================================="
          
          python app.py 2>&1 | tee /tmp/scraper_output.txt
          
          echo ""
          echo "=========================================="
          echo "ğŸ“¤ å¤„ç†è¾“å‡º..."
          echo "=========================================="
          
          # ä½¿ç”¨ Python æå–å¹¶éªŒè¯ JSON
          python3 << 'EOF'
          import re, json
          
          with open('/tmp/scraper_output.txt', 'r', encoding='utf-8') as f:
              content = f.read()
          
          match = re.search(r'\{[\s\S]*\}', content)
          if match:
              try:
                  # è§£æå¹¶é‡æ–°æ ¼å¼åŒ– JSONï¼Œç¡®ä¿å®Œæ•´æ€§
                  data = json.loads(match.group())
                  with open('/tmp/json_output.txt', 'w', encoding='utf-8') as f:
                      json.dump(data, f, ensure_ascii=False, indent=4)
                  print(f"JSON extracted successfully! Issues: {data.get('issue_count', 0)}")
              except json.JSONDecodeError as e:
                  print(f"JSON parse error: {e}")
                  with open('/tmp/json_output.txt', 'w') as f:
                      f.write('{}')
          else:
              print("No JSON found in output")
              with open('/tmp/json_output.txt', 'w') as f:
                  f.write('{}')
          EOF
          
          # å¤åˆ¶åˆ°é¡¹ç›®ç›®å½•ä¾› GitHub Pages ä½¿ç”¨
          cp /tmp/json_output.txt transit_data.json
          
          echo "æå–çš„ JSON é¢„è§ˆ:"
          head -20 /tmp/json_output.txt
          echo "..."

      - name: ğŸ“¤ Update GitHub Pages
        run: |
          echo "=========================================="
          echo "ğŸ“¤ æ›´æ–° GitHub Pages..."
          echo "=========================================="
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add transit_data.json
          git commit -m "ğŸšƒ Update transit data $(date '+%Y-%m-%d %H:%M') JST" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: ğŸ“¤ Send Notification to Synology Chat
        if: ${{ github.event.inputs.send_notification != 'false' }}
        env:
          SYNOLOGY_WEBHOOK: ${{ secrets.SYNOLOGY_CHAT_WEBHOOK }}
        run: |
          echo "=========================================="
          echo "ğŸ“¤ å‘é€é€šçŸ¥åˆ° Synology Chat..."
          echo "=========================================="
          
          # æ£€æŸ¥ JSON æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if ! jq empty /tmp/json_output.txt 2>/dev/null; then
            echo "âŒ JSON æ–‡ä»¶æ— æ•ˆï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # ä½¿ç”¨ jq è§£æ JSON
          UPDATE_TIME=$(jq -r '.update_time // "Unknown"' /tmp/json_output.txt)
          ISSUE_COUNT=$(jq -r '.issue_count // 0' /tmp/json_output.txt)
          STATUS=$(jq -r '.status // "unknown"' /tmp/json_output.txt)
          
          echo "è§£æç»“æœ: æ›´æ–°æ—¶é—´=$UPDATE_TIME, é—®é¢˜æ•°=$ISSUE_COUNT, çŠ¶æ€=$STATUS"
          
          # æ ¹æ®çŠ¶æ€æ„å»ºæ¶ˆæ¯
          if [ "$STATUS" = "all_clear" ] || [ "$ISSUE_COUNT" = "0" ]; then
            MESSAGE="âœ… ã€æ±äº¬äº¤é€šæƒ…å ±ã€‘å…¨ç·šæ­£å¸¸é‹è»¢ä¸­ï¼\n\nğŸ• æ›´æ–°æ™‚é–“: $UPDATE_TIME (JST)\nğŸ”— https://workhmz.github.io/tokyo-transit-monitor/"
          else
            # ä½¿ç”¨ jq æå–è·¯çº¿ä¿¡æ¯ï¼ˆæœ€å¤šæ˜¾ç¤º5æ¡ï¼Œæˆªå–å‰30å­—ç¬¦ï¼‰
            LINES_INFO=$(jq -r '.issues[:5][] | "â€¢ \(.line): \(.detail[0:30])..."' /tmp/json_output.txt 2>/dev/null || echo "")
            
            MESSAGE="âš ï¸ ã€æ±äº¬äº¤é€šæƒ…å ±ã€‘${ISSUE_COUNT}ä»¶ã®é‹è¡Œæƒ…å ±\n\nğŸ• æ›´æ–°: $UPDATE_TIME (JST)\n\n${LINES_INFO}\n\nğŸ”— è©³ç´°: https://workhmz.github.io/tokyo-transit-monitor/"
          fi
          
          echo "å‘é€æ¶ˆæ¯å†…å®¹:"
          echo -e "$MESSAGE"
          
          # å‘é€åˆ° Synology Chat
          if [ -n "$SYNOLOGY_WEBHOOK" ]; then
            curl -k -X POST "$SYNOLOGY_WEBHOOK" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              --data-urlencode "payload={\"text\": \"$MESSAGE\"}"
          else
            echo "âš ï¸ SYNOLOGY_WEBHOOK æœªè®¾ç½®"
          fi
          
          echo ""
          echo "=========================================="
          echo "âœ… å®Œæˆï¼"
          echo "=========================================="
