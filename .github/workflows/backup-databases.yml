# =============================================================================
# Database Backup: PostgreSQL -> Azure Blob Storage
# =============================================================================
# è§¦å‘ï¼šæ¯å‘¨ä¸€å‡Œæ™¨ 4:00 JST (= å‘¨æ—¥ 19:00 UTC) æˆ– æ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½ï¼šå¤‡ä»½ Neon/Supabase æ•°æ®åº“åˆ° Azure Blobï¼Œå‘é€ç»“æœåˆ° Synology Chat
# =============================================================================

name: ğŸ’¾ Database Backup

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 4:00 JST = å‘¨æ—¥ 19:00 UTC
    - cron: '0 19 * * 0'
  
  workflow_dispatch:
    inputs:
      databases:
        description: 'é€‰æ‹©è¦å¤‡ä»½çš„æ•°æ®åº“'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'lobechat'
          - 'vaultwarden'
      cleanup_old:
        description: 'æ˜¯å¦æ¸…ç†30å¤©å‰çš„å¤‡ä»½ï¼Ÿ'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AZURE_CONTAINER: database-backups
  BACKUP_RETENTION_DAYS: 30

jobs:
  backup:
    name: ğŸ“¦ Backup Databases
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
      matrix:
        include:
          - name: lobechat
            db_secret: NEON_LOBECHAT_DB_URL
            folder: neon
            display_name: "LobeChat (Neon)"
          - name: vaultwarden
            db_secret: SUPABASE_VAULTWARDEN_DB_URL
            folder: supabase
            display_name: "Vaultwarden (Supabase)"
          # ----------------------------------------
          # æ·»åŠ æ–°æ•°æ®åº“ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ï¼‰:
          # ----------------------------------------
          # - name: another_db
          #   db_secret: SUPABASE_ANOTHER_DB_URL
          #   folder: supabase
          #   display_name: "Another DB (Supabase)"

    outputs:
      backup_results: ${{ steps.backup.outputs.result }}

    steps:
      # ----- æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½æ­¤æ•°æ®åº“ -----
      - name: ğŸ” Check if should backup
        id: check
        run: |
          INPUT="${{ github.event.inputs.databases || 'all' }}"
          if [ "$INPUT" = "all" ] || [ "$INPUT" = "${{ matrix.name }}" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "â© è·³è¿‡ ${{ matrix.display_name }}ï¼ˆæœªé€‰ä¸­ï¼‰"
          fi

      # ----- å®‰è£… PostgreSQL 17 å®¢æˆ·ç«¯ï¼ˆè§£å†³ Neon ç‰ˆæœ¬ä¸åŒ¹é…é—®é¢˜ï¼‰-----
      - name: ğŸ”§ Install PostgreSQL 17 Client
        if: steps.check.outputs.should_run == 'true'
        run: |
          # æ·»åŠ  PostgreSQL å®˜æ–¹æº
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          
          # å®‰è£… PostgreSQL 17 å®¢æˆ·ç«¯
          sudo apt-get install -y postgresql-client-17
          
          # éªŒè¯ç‰ˆæœ¬
          echo "âœ… pg_dump: $(/usr/lib/postgresql/17/bin/pg_dump --version)"

      # ----- æ‰§è¡Œå¤‡ä»½ -----
      - name: ğŸ’¾ Backup ${{ matrix.display_name }}
        id: backup
        if: steps.check.outputs.should_run == 'true'
        env:
          DB_URL: ${{ secrets[matrix.db_secret] }}
        run: |
          set -e
          
          echo "==========================================="
          echo "ğŸš€ å¼€å§‹å¤‡ä»½: ${{ matrix.display_name }}"
          echo "==========================================="
          
          # ä½¿ç”¨ PostgreSQL 17 çš„ pg_dump
          PG_DUMP="/usr/lib/postgresql/17/bin/pg_dump"
          
          # ç”Ÿæˆæ–‡ä»¶å: lobechat_20260128.sql.gz
          DATE=$(date +'%Y%m%d')
          FILENAME="${{ matrix.name }}_${DATE}.sql.gz"
          
          echo "ğŸ“ å¤‡ä»½æ–‡ä»¶: $FILENAME"
          
          # æ£€æŸ¥æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
          if [ -z "$DB_URL" ]; then
            echo "âŒ é”™è¯¯: æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æœªè®¾ç½® (secret: ${{ matrix.db_secret }})"
            echo "result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ‰§è¡Œå¤‡ä»½
          echo "ğŸ“¤ æ­£åœ¨å¯¼å‡ºæ•°æ®åº“..."
          START_TIME=$(date +%s)
          
          if ! $PG_DUMP "$DB_URL" 2>&1 | gzip > "$FILENAME"; then
            echo "âŒ pg_dump å¤±è´¥"
            echo "result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          # éªŒè¯å¤‡ä»½æ–‡ä»¶
          FILE_SIZE=$(stat -c%s "$FILENAME" 2>/dev/null || stat -f%z "$FILENAME")
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          
          echo "ğŸ“Š å¤‡ä»½å¤§å°: ${FILE_SIZE_MB} MB"
          echo "â±ï¸  è€—æ—¶: ${DURATION} ç§’"
          
          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "âš ï¸ è­¦å‘Š: å¤‡ä»½æ–‡ä»¶è¿‡å° (${FILE_SIZE} bytes)ï¼Œå¯èƒ½æœ‰é—®é¢˜"
            echo "result=warning" >> $GITHUB_OUTPUT
            echo "warning=å¤‡ä»½æ–‡ä»¶è¿‡å°" >> $GITHUB_OUTPUT
          fi
          
          # ä¸Šä¼ åˆ° Azure Blob
          echo ""
          echo "â˜ï¸ æ­£åœ¨ä¸Šä¼ åˆ° Azure Blob Storage..."
          
          az storage blob upload \
            --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --container-name "${{ env.AZURE_CONTAINER }}" \
            --file "$FILENAME" \
            --name "${{ matrix.folder }}/$FILENAME" \
            --overwrite true
          
          echo ""
          echo "âœ… å¤‡ä»½å®Œæˆ!"
          echo "ğŸ“ è·¯å¾„: ${{ env.AZURE_CONTAINER }}/${{ matrix.folder }}/$FILENAME"
          
          # è¾“å‡ºç»“æœ
          echo "result=success" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "size_mb=${FILE_SIZE_MB}" >> $GITHUB_OUTPUT
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT

      # ----- è®°å½•è·³è¿‡çŠ¶æ€ -----
      - name: ğŸ“ Set skipped status
        if: steps.check.outputs.should_run == 'false'
        id: skipped
        run: echo "result=skipped" >> $GITHUB_OUTPUT

  # ===========================================================================
  # æ¸…ç†æ—§å¤‡ä»½
  # ===========================================================================
  cleanup:
    name: ğŸ§¹ Cleanup Old Backups
    runs-on: ubuntu-latest
    needs: backup
    if: ${{ github.event.inputs.cleanup_old != 'false' }}
    
    steps:
      - name: ğŸ—‘ï¸ Delete old backups
        run: |
          echo "==========================================="
          echo "ğŸ§¹ æ¸…ç† ${{ env.BACKUP_RETENTION_DAYS }} å¤©å‰çš„å¤‡ä»½"
          echo "==========================================="
          
          # è®¡ç®—æˆªæ­¢æ—¥æœŸ
          CUTOFF_DATE=$(date -d "-${{ env.BACKUP_RETENTION_DAYS }} days" +'%Y%m%d')
          echo "ğŸ“… åˆ é™¤ ${CUTOFF_DATE} ä¹‹å‰çš„å¤‡ä»½"
          
          # åˆ—å‡ºæ‰€æœ‰ blob
          BLOBS=$(az storage blob list \
            --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            --container-name "${{ env.AZURE_CONTAINER }}" \
            --query "[].name" -o tsv)
          
          DELETED_COUNT=0
          
          for BLOB in $BLOBS; do
            # ä»æ–‡ä»¶åæå–æ—¥æœŸ (æ ¼å¼: folder/name_YYYYMMDD.sql.gz)
            BLOB_DATE=$(echo "$BLOB" | grep -oP '\d{8}' || echo "")
            
            if [ -n "$BLOB_DATE" ] && [ "$BLOB_DATE" -lt "$CUTOFF_DATE" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤: $BLOB"
              az storage blob delete \
                --connection-string "${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                --container-name "${{ env.AZURE_CONTAINER }}" \
                --name "$BLOB"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done
          
          echo ""
          echo "âœ… æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ ${DELETED_COUNT} ä¸ªæ—§å¤‡ä»½"

  # ===========================================================================
  # å‘é€é€šçŸ¥åˆ° Synology Chat
  # ===========================================================================
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [backup, cleanup]
    if: always()
    
    steps:
      - name: ğŸ“¨ Send to Synology Chat
        env:
          SYNOLOGY_WEBHOOK: ${{ secrets.SYNOLOGY_CHAT_WEBHOOK }}
        run: |
          # è·å–å½“å‰æ—¶é—´
          TIMESTAMP=$(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M JST')
          
          # åˆ¤æ–­æ•´ä½“çŠ¶æ€
          BACKUP_STATUS="${{ needs.backup.result }}"
          CLEANUP_STATUS="${{ needs.cleanup.result }}"
          
          if [ "$BACKUP_STATUS" = "success" ]; then
            ICON="âœ…"
            TITLE="æ•°æ®åº“å¤‡ä»½æˆåŠŸ"
          elif [ "$BACKUP_STATUS" = "failure" ]; then
            ICON="âŒ"
            TITLE="æ•°æ®åº“å¤‡ä»½å¤±è´¥"
          else
            ICON="âš ï¸"
            TITLE="æ•°æ®åº“å¤‡ä»½éƒ¨åˆ†å®Œæˆ"
          fi
          
          # æ„å»ºæ¶ˆæ¯
          MESSAGE="$ICON ã€$TITLEã€‘\\n\\n"
          MESSAGE+="ğŸ• æ—¶é—´: $TIMESTAMP\\n"
          MESSAGE+="ğŸ“¦ å¤‡ä»½çŠ¶æ€: $BACKUP_STATUS\\n"
          MESSAGE+="ğŸ§¹ æ¸…ç†çŠ¶æ€: $CLEANUP_STATUS\\n\\n"
          MESSAGE+="ğŸ“ å­˜å‚¨ä½ç½®: Azure Blob (${{ env.AZURE_CONTAINER }})"
          
          echo "å‘é€é€šçŸ¥..."
          echo -e "$MESSAGE"
          
          # å‘é€åˆ° Synology Chat
          if [ -n "$SYNOLOGY_WEBHOOK" ]; then
            curl -k -X POST "$SYNOLOGY_WEBHOOK" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              --data-urlencode "payload={\"text\": \"$MESSAGE\"}"
            echo ""
            echo "âœ… é€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ SYNOLOGY_CHAT_WEBHOOK æœªè®¾ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi
